<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ team1_short_name }} vs {{ team2_short_name }} - IPL Replay</title>
    <style>
        :root { /* Light Theme (Default) */
            --body-bg: #f4f6f9;
            --header-bg: #ffffff;
            --header-text: #333;
            --header-accent: #007bff;
            --new-match-button-bg: #007bff;
            --new-match-button-text: #ffffff;
            --new-match-button-hover-bg: #0056b3;

            --container-bg: #ffffff;
            --section-bg: #f0f0f0;
            --text-color: #343a40;
            --heading-color: #007bff;
            --subheading-color: #4a6572;
            --accent-color: #007bff;
            --player-highlight-color: #d9534f;

            /* LED Display */
            --led-display-bg: #e9ecef;
            --led-display-span-text: #343a40; /* General text for non-outcome spans */
            --led-runs-0-bg: #d4edda;
            --led-runs-0-text: #155724;
            --led-runs-123-bg: #cfe2ff;
            --led-runs-123-text: #084298;
            --led-runs-456-bg: #fff3cd;
            --led-runs-456-text: #664d03;
            --led-wicket-bg: #f8d7da;
            --led-wicket-text: #58151c;
            --led-extra-bg: #cff4fc;
            --led-extra-text: #055160;
            --led-default-bg: #e9ecef;
            --led-default-text: #495057;

            /* Commentary & Log */
            --commentary-bg: #f8f9fa; /* Section bg for commentary box */
            --last-ball-commentary-bg: #e9ecef; /* Specific bg for last ball text area */
            --log-bg: #f8f9fa;  /* Section bg for full log box */
            --full-innings-log-bg: #e9ecef; /* Specific bg for log scroll area */
            --log-entry-border: #dee2e6;

            /* Win Message */
            --win-message-bg: #d1ecf1;
            --win-message-text: #0c5460;
            --win-message-border: #bee5eb;

            /* Bottom Control Bar */
            --control-bar-bg: #f8f9fa;
            --control-bar-button-bg: #007bff;
            --control-bar-button-text: #ffffff;
            --control-bar-button-border: #007bff;
            --control-bar-button-hover-bg: #0056b3;
            --control-bar-button-hover-text: #ffffff;
            --control-bar-button-disabled-bg: #cccccc;
            --control-bar-button-disabled-text: #666666;
            --control-bar-button-disabled-border: #cccccc;
            --control-bar-select-bg: #ffffff;
            --control-bar-select-text: #343a40;
            --control-bar-select-border: #ced4da;
            --control-bar-label-text: #343a40;

            /* Scorecard Tables (Modal & First Innings) */
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --modal-content-bg: #ffffff;
            --scorecard-table-text: #343a40;
            --scorecard-table-header-bg: #e9ecef;
            --scorecard-table-header-text: #007bff;
            --scorecard-table-border: #dee2e6;
            --scorecard-table-row-odd-bg: #f8f9fa;
            --scorecard-table-row-hover-bg: #e9ecef;
            --modal-close-button-text: #007bff;
            --modal-close-button-hover-text: #0056b3;
            --result-highlight-replay-bg: #d1ecf1;
            --result-highlight-replay-text: #0c5460;
            --first-innings-scorecard-bg: #e9ecef; /* Similar to other sections */
        }

        [data-theme="dark"] {
            --body-bg: #1e1e1e;
            --header-bg: #181818;
            --header-text: #f1c40f;
            --header-accent: #f1c40f;
            --new-match-button-bg: #f1c40f;
            --new-match-button-text: #1e272e;
            --new-match-button-hover-bg: #e0b804;

            --container-bg: #2c2c2c;
            --section-bg: #3a3a3a;
            --text-color: #fff;
            --heading-color: #ffcc00;
            --subheading-color: #eee;
            --accent-color: #ffcc00;
            --player-highlight-color: #ffeb3b;

            /* LED Display */
            --led-display-bg: #111;
            --led-display-span-text: #fff; /* General text for non-outcome spans */
            --led-runs-0-bg: #7f8c8d;
            --led-runs-0-text: white;
            --led-runs-123-bg: #ecf0f1;
            --led-runs-123-text: #2c3e50;
            --led-runs-456-bg: #f1c40f;
            --led-runs-456-text: #333;
            --led-wicket-bg: #e74c3c;
            --led-wicket-text: white;
            --led-extra-bg: #3498db;
            --led-extra-text: white;
            --led-default-bg: #bdc3c7;
            --led-default-text: #333;

            /* Commentary & Log */
            --commentary-bg: #3a3a3a; /* Section bg */
            --last-ball-commentary-bg: #4a4a4a;
            --log-bg: #3a3a3a; /* Section bg */
            --full-innings-log-bg: #222;
            --log-entry-border: #444;

            /* Win Message */
            --win-message-bg: #dff0d8;
            --win-message-text: #3c763d;
            --win-message-border: #4CAF50;

            /* Bottom Control Bar */
            --control-bar-bg: #1e272e;
            --control-bar-button-bg: #2c3e50;
            --control-bar-button-text: #f1c40f;
            --control-bar-button-border: #f1c40f;
            --control-bar-button-hover-bg: #f1c40f;
            --control-bar-button-hover-text: #1e272e;
            --control-bar-button-disabled-bg: #3a3a3a;
            --control-bar-button-disabled-text: #777777;
            --control-bar-button-disabled-border: #555555;
            --control-bar-select-bg: #2c3e50;
            --control-bar-select-text: white;
            --control-bar-select-border: #f1c40f;
            --control-bar-label-text: #ecf0f1;

            /* Scorecard Tables (Modal & First Innings) */
            --modal-overlay-bg: rgba(0, 0, 0, 0.85);
            --modal-content-bg: #2c3e50;
            --scorecard-table-text: #ecf0f1;
            --scorecard-table-header-bg: #34495e;
            --scorecard-table-header-text: #f1c40f;
            --scorecard-table-border: #4a6572;
            --scorecard-table-row-odd-bg: #3b5363;
            --scorecard-table-row-hover-bg: #4a6572;
            --modal-close-button-text: #f1c40f;
            --modal-close-button-hover-text: #ffffff;
            --result-highlight-replay-bg: #27ae60;
            --result-highlight-replay-text: white;
            --first-innings-scorecard-bg: #283740; /* Original dark theme color */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--body-bg);
            color: var(--text-color);
            padding-top: 70px; /* For fixed header */
            padding-bottom: 75px; /* For fixed bottom control bar */
            box-sizing: border-box;
        }
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: var(--header-bg);
            color: var(--header-text); /* Fallback, h1 has its own color */
            border-bottom: 2px solid var(--header-accent);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-sizing: border-box;
        }
        .header-title h1 {
            margin: 0;
            font-size: 1.6em;
            font-weight: bold;
            color: var(--header-accent);
        }
        .new-match-button {
            padding: 10px 18px;
            font-size: 1em;
            background-color: var(--new-match-button-bg);
            color: var(--new-match-button-text);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        .new-match-button:hover {
            background-color: var(--new-match-button-hover-bg);
        }
        .container {
            width: 100%;
            max-width: 960px;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); /* This shadow is quite dark, might need adjustment or variable */
            margin: 0 auto 20px auto; /* Adjusted margin for body padding */
        }
        h2 {
            text-align: center;
            color: var(--heading-color);
            font-size: 1.6em; margin-bottom: 15px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
        }
        h3 { /* Also applies to static h3 in scorecard displays */
            text-align: center;
            color: var(--subheading-color);
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        /* Specific H3s if needed, e.g. scorecard titles */
        #firstInningsScorecardDisplay h3, #finalScorecardModal h2 { /* Modal h2 is styled like a prominent h3 */
             color: var(--heading-color); /* Use main heading color for these titles */
        }
        .section {
            margin-bottom: 15px;
            padding: 12px;
            background-color: var(--section-bg);
            border-radius: 8px;
        }
        .section p { margin: 6px 0; font-size: 1em; }
        .section strong { color: var(--accent-color); }

        #led-display {
            text-align: center; padding: 15px;
            background-color: var(--led-display-bg);
            border-radius: 8px; margin-bottom: 15px; font-size: 1.5em;
            display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;
        }
        #led-display span { /* For non-outcome spans like "Ball:", "Score:" */
            padding: 8px 15px; border-radius: 5px;
            min-width: 80px; display: inline-block; margin: 5px; text-align:center;
            color: var(--led-display-span-text); /* Ensure text is visible on --led-display-bg */
        }
        #led-ball-outcome { font-weight: bold; }
        .led-runs-0 { background-color: var(--led-runs-0-bg); color: var(--led-runs-0-text); }
        .led-runs-123 { background-color: var(--led-runs-123-bg); color: var(--led-runs-123-text); }
        .led-runs-456 { background-color: var(--led-runs-456-bg); color: var(--led-runs-456-text); }
        .led-wicket { background-color: var(--led-wicket-bg); color: var(--led-wicket-text); }
        .led-extra { background-color: var(--led-extra-bg); color: var(--led-extra-text); }
        .led-default { background-color: var(--led-default-bg); color: var(--led-default-text); }

        .player-highlight { font-weight: bold; color: var(--player-highlight-color); }

        .commentary-box { background-color: var(--commentary-bg); }
        #last-ball-commentary { font-size: 1.1em; text-align: center; min-height: 25px; padding: 8px; background-color: var(--last-ball-commentary-bg); border-radius: 5px;}
        .full-log-box { background-color: var(--log-bg); }
        #full-innings-log { max-height: 150px; overflow-y: auto; padding: 8px; background-color: var(--full-innings-log-bg); border-radius: 5px; font-size: 0.85em; }
        .log-entry { border-bottom: 1px solid var(--log-entry-border); padding: 5px 0; }
        .log-entry:last-child { border-bottom: none; }
        .win-message {
            text-align: center; font-size: 1.5em; font-weight: bold; padding: 15px;
            background-color: var(--win-message-bg);
            border: 1px solid var(--win-message-border);
            border-radius: 5px; color: var(--win-message-text);
        }
        .hidden { display: none; }
        .team-logo-pbs { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; border-radius: 50%; background-color: var(--container-bg); padding:1px; }
        .team-display { display: flex; align-items: center; margin-bottom: 5px;}
        .team-display .name {font-size: 1.1em; font-weight:bold;}
        .team-display .score-details {font-size: 1em; margin-left:8px;}

        /* Bottom Control Bar Styles START */
        .bottom-control-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--control-bar-bg);
            color: var(--control-bar-label-text); /* Text color for labels inside bar */
            padding: 12px 0;
            display: flex; justify-content: space-evenly; align-items: center;
            z-index: 1010; box-shadow: 0 -2px 8px rgba(0,0,0,0.3); box-sizing: border-box;
        }
        .control-bar-button {
            background-color: var(--control-bar-button-bg);
            color: var(--control-bar-button-text);
            border: 1px solid var(--control-bar-button-border);
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.2s ease, color 0.2s ease;
            margin: 0 8px; /* Adjusted margin */
        }
        .control-bar-button:hover {
            background-color: var(--control-bar-button-hover-bg);
            color: var(--control-bar-button-hover-text);
            border-color: var(--control-bar-button-hover-bg); /* Border matches hover background */
        }
        .control-bar-button:disabled {
            background-color: var(--control-bar-button-disabled-bg);
            color: var(--control-bar-button-disabled-text);
            border-color: var(--control-bar-button-disabled-border);
            cursor: not-allowed;
        }
        .control-bar-select {
            padding: 9px 12px; /* Slightly adjust padding for consistency */
            border-radius: 5px; /* Keep or match button radius if desired, 5px is fine */
            border: 1px solid var(--control-bar-select-border);
            background-color: var(--control-bar-select-bg);
            color: var(--control-bar-select-text);
            font-size: 0.9em;
            margin: 0 5px;
        }
        .speed-control-container { display: flex; align-items: center; margin: 0 5px; }
        .speed-control-container label {
            margin-right: 8px;
            font-weight: normal;
            font-size: 0.9em;
            color: var(--control-bar-label-text);
        }
        /* Bottom Control Bar Styles END */

        /* Final Scorecard Table Styles START */
        .scorecard-table {
            width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px;
            font-size: 0.9em; color: var(--scorecard-table-text);
        }
        .scorecard-table th, .scorecard-table td {
            border: 1px solid var(--scorecard-table-border);
            padding: 8px 10px; text-align: left;
        }
        .scorecard-table th {
            background-color: var(--scorecard-table-header-bg);
            color: var(--scorecard-table-header-text); font-weight: bold;
        }
        .scorecard-table tbody tr:nth-child(odd) { background-color: var(--scorecard-table-row-odd-bg); }
        .scorecard-table tbody tr:hover { background-color: var(--scorecard-table-row-hover-bg); }
        .result-highlight-replay { /* Style for result in final scorecard */
             margin-top:20px; padding:15px; text-align:center;
             background-color: var(--result-highlight-replay-bg);
             color: var(--result-highlight-replay-text); border-radius: 5px;
        }
        .result-highlight-replay h4 {color: var(--result-highlight-replay-text);} /* Ensure h4 color matches text */
         /* Final Scorecard Table Styles END */

        .view-scorecard-btn {
            background-color: var(--control-bar-button-bg, #2c3e50);
            color: var(--control-bar-button-text, #f1c40f);
            border: 1px solid var(--control-bar-button-border, #f1c40f);
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 12px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .view-scorecard-btn:hover {
            background-color: var(--control-bar-button-hover-bg, #f1c40f);
            color: var(--control-bar-button-hover-text, #1e272e);
        }

        #themeToggleBtnBallByBall {
            background-color: var(--new-match-button-bg);
            color: var(--new-match-button-text);
            border: 1px solid var(--new-match-button-bg);
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        #themeToggleBtnBallByBall:hover {
            background-color: var(--new-match-button-hover-bg);
            color: var(--new-match-button-text); /* Assuming hover bg still contrasts with this */
        }

        .view-scorecard-btn {
            background-color: var(--control-bar-button-bg, #2c3e50);
            color: var(--control-bar-button-text, #f1c40f);
            border: 1px solid var(--control-bar-button-border, #f1c40f);
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 12px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .view-scorecard-btn:hover {
            background-color: var(--control-bar-button-hover-bg, #f1c40f);
            color: var(--control-bar-button-hover-text, #1e272e);
        }

        /* CSS for Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            z-index: 2000; /* High z-index */
            display: none; /* Hidden by default */
            align-items: center; /* For centering content if needed, though content will be scrollable */
            justify-content: center;
            padding: 20px; /* Padding for smaller screens, content will define its own max-width */
            box-sizing: border-box;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            padding: 25px;
            border-radius: 8px;
            width: 100%;
            max-width: 900px; /* Max width for the scorecard content */
            max-height: 90vh; /* Max height */
            overflow-y: auto; /* Scrollable content */
            position: relative; /* For positioning the close button */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .close-modal-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: var(--modal-close-button-text);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }
        .close-modal-button:hover {
            color: var(--modal-close-button-hover-text);
        }

        .new-scorecard-close-button {
            background-color: var(--new-match-button-bg);
            color: var(--new-match-button-text);
            border: 1px solid var(--new-match-button-bg); /* Using background for border too */
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: block; /* Ensure this is present */
            margin: 20px auto 10px auto; /* Ensure this is present */
        }

        .new-scorecard-close-button:hover {
            background-color: var(--new-match-button-hover-bg);
            /* color: var(--new-match-button-text); /* Text color can remain same or change like other hover states */
        }
    </style>
</head>
<body>
    <header class="match-header">
        <div class="header-title"><h1>{{ team1_short_name }} vs {{ team2_short_name }}</h1></div>
        <div class="header-actions">
            <form action="{{ url_for('index') }}" method="get" style="margin: 0; display: inline-block;"><button type="submit" class="new-match-button">New Match</button></form>
            <button id="themeToggleBtnBallByBall" style="padding: 8px 12px; margin-left: 10px; cursor: pointer;">Toggle Theme</button>
        </div>
    </header>

    <div class="container">
        <div id="tossDisplay" class="section"></div>
        <div id="led-display">
            <span>Ball: <span id="led-ball-number">0.0</span></span>
            <span>Outcome: <span id="led-ball-outcome" class="led-default">---</span></span>
            <span>Score: <span id="led-current-total">0/0</span></span>
        </div>
        <div class="section score-info">
            <h2>Scoreboard</h2>

            <!-- New placeholder for 1st Innings Summary -->
            <div id="firstInningsSummaryDisplay" class="team-display" style="display: none; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--log-entry-border, #444);">
                <!-- Content will be populated by JavaScript. Structure will be similar to other .team-display divs -->
            </div>

            <!-- New placeholder for 2nd Innings Summary -->
            <div id="secondInningsSummaryDisplay" class="team-display" style="display: none; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--log-entry-border, #444);">
                <!-- Content will be populated by JavaScript. -->
            </div>

            <div class="team-display batting-team-display">
                <img src="" alt="Batting Team Logo" class="team-logo-pbs" id="battingTeamLogo">
                <div>
                    <span class="name" id="battingTeamName">N/A</span>
                    <span class="score-details">Score:
                        <span id="currentScore">0</span>/<span id="currentWickets">0</span>
                        (<span id="currentOvers">0.0</span> Overs)
                    </span>
                    <span class="run-rate-display" id="currentRunRateDisplay" style="font-size: 0.9em; margin-left: 10px; display: none;">
                        RR: <span id="currentRunRateValue">0.00</span>
                    </span>
                    <!-- New: 2nd Innings RR & RRR -->
                    <span class="run-rate-display" id="secondInningsRRDisplay" style="font-size: 0.9em; margin-left: 10px; display: none;">
                        RR: <span id="secondInningsRRValue">0.00</span>
                    </span>
                    <span class="run-rate-display" id="requiredRunRateDisplay" style="font-size: 0.9em; margin-left: 10px; display: none;">
                        RRR: <span id="requiredRunRateValue">0.00</span>
                    </span>
                </div>
            </div>
            <div class="team-display bowling-team-display" style="margin-top:8px;">
                <img src="" alt="Bowling Team Logo" class="team-logo-pbs" id="bowlingTeamLogo">
                 <span class="name" id="bowlingTeamName">N/A</span>
            </div>
            <div id="targetInfo" class="hidden" style="margin-top:12px;">
                <p><strong>Target:</strong> <span id="targetScore">0</span></p>
                <p><strong>Needed:</strong> <span id="runsNeeded">0</span> runs from <span id="ballsRemaining">0</span> balls</p>
            </div>
        </div>
        <div class="section players-info">
            <h3>Players</h3>
            <p>On Strike: <span id="batsman-onstrike" class="player-highlight">N/A</span></p>
            <p>Non-Striker: <span id="batsman-nonstrike">N/A</span></p>
            <p>Current Bowler: <span id="current-bowler">N/A</span></p>
        </div>
        <div id="winMessageContainer" class="win-message hidden"></div>

        <div class="section commentary-box"><h3>Commentary</h3><div id="last-ball-commentary">Match Replay Ready. Click Next Ball or Auto-Play.</div></div>
        <div class="section full-log-box"><h3>Full Log (Current Innings)</h3><div id="full-innings-log"></div></div>

        <!-- New Modal for First Innings Scorecard -->
        <div id="firstInningsScorecardModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" id="firstInningsModalContent">
                <button id="closeFirstInningsModalBtn" class="close-modal-button">&times;</button>
                <h2 style="text-align: center; color: var(--heading-color); margin-bottom: 20px;">First Innings Scorecard</h2>
                <div id="firstInningsScorecardDataContainer">
                    <!-- Scorecard content for 1st innings will be injected here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- New Modal for Second Innings Scorecard -->
        <div id="secondInningsScorecardModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" id="secondInningsModalContent">
                <button id="closeSecondInningsModalBtn" class="close-modal-button">&times;</button>
                <h2 style="text-align: center; color: var(--heading-color); margin-bottom: 20px;">Second Innings Scorecard</h2>
                <div id="secondInningsScorecardDataContainer">
                    <!-- Scorecard content for 2nd innings will be injected here by JavaScript -->
                </div>
            </div>
        </div>

        <div id="finalScorecardModal" class="modal-overlay" style="display: none;">
            <div id="finalScorecardDisplay" class="modal-content" style="margin-top: 0;">
                <button id="closeScorecardModalBtn" class="close-modal-button">&times;</button>
                <h2 style="text-align: center; color: var(--heading-color); margin-bottom: 20px;">Full Match Scorecard</h2>
                {# Content will be generated by JavaScript by generateFullScorecardHTML() #}
            </div>
        </div>
    </div>

    <div class="bottom-control-bar">
        <button id="nextBallBtn" class="control-bar-button">Next Ball</button>
        <div class="speed-control-container">
            <label for="simSpeed">Speed:</label>
            <select id="simSpeed" class="control-bar-select">
                <option value="2000">Slow (2s)</option>
                <option value="1000" selected>Medium (1s)</option>
                <option value="500">Fast (0.5s)</option>
                <option value="200">Rapid (0.2s)</option>
            </select>
        </div>
        <button id="startAutoPlayBtn" class="control-bar-button">Auto-Play</button>
        <button id="pauseAutoPlayBtn" class="control-bar-button" style="display:none;">Pause</button>
        <button id="viewScorecardBtn" class="control-bar-button" style="display:none;">View Scorecard</button>
    </div>

    <script>
        const fullMatchData = {{ full_match_data | tojson }};

        // DOM Elements (assuming they are all correctly defined above)
        const tossDisplayEl = document.getElementById('tossDisplay');
        const ledBallNumEl = document.getElementById('led-ball-number');
        const ledOutcomeEl = document.getElementById('led-ball-outcome');
        const ledScoreEl = document.getElementById('led-current-total');
        const battingTeamNameEl = document.getElementById('battingTeamName');
        const battingTeamLogoEl = document.getElementById('battingTeamLogo');
        const currentScoreEl = document.getElementById('currentScore');
        const currentWicketsEl = document.getElementById('currentWickets');
        const currentOversEl = document.getElementById('currentOvers');
        const bowlingTeamNameEl = document.getElementById('bowlingTeamName');
        const bowlingTeamLogoEl = document.getElementById('bowlingTeamLogo');
        const targetInfoEl = document.getElementById('targetInfo');
        const targetScoreEl = document.getElementById('targetScore');
        const runsNeededEl = document.getElementById('runsNeeded');
        const ballsRemainingEl = document.getElementById('ballsRemaining');
        const onStrikeBatsmanEl = document.getElementById('batsman-onstrike');
        const nonStrikeBatsmanEl = document.getElementById('batsman-nonstrike');
        const currentBowlerEl = document.getElementById('current-bowler');
        const winMessageContainerEl = document.getElementById('winMessageContainer');
        const nextBallBtn = document.getElementById('nextBallBtn');
        const simSpeedSelect = document.getElementById('simSpeed');
        const startAutoPlayBtn = document.getElementById('startAutoPlayBtn');
        const pauseAutoPlayBtn = document.getElementById('pauseAutoPlayBtn');
        const lastBallCommentaryEl = document.getElementById('last-ball-commentary');
        const fullInningsLogEl = document.getElementById('full-innings-log');
        const finalScorecardDiv = document.getElementById('finalScorecardDisplay'); // This is the content area within the finalScorecardModal
        // const firstInningsScorecardDiv = document.getElementById('firstInningsScorecardDisplay'); // This line is removed
        const finalScorecardModal = document.getElementById('finalScorecardModal');
        const closeScorecardModalBtn = document.getElementById('closeScorecardModalBtn');
        const bottomControlBar = document.querySelector('.bottom-control-bar');
        const firstInningsSummaryDisplay = document.getElementById('firstInningsSummaryDisplay');
        const currentRunRateDisplay = document.getElementById('currentRunRateDisplay');
        const currentRunRateValue = document.getElementById('currentRunRateValue');
        const secondInningsRRDisplay = document.getElementById('secondInningsRRDisplay');
        const secondInningsRRValue = document.getElementById('secondInningsRRValue');
        const requiredRunRateDisplay = document.getElementById('requiredRunRateDisplay');
        const requiredRunRateValue = document.getElementById('requiredRunRateValue');
        const firstInningsScorecardModal = document.getElementById('firstInningsScorecardModal');
        const firstInningsScorecardDataContainer = document.getElementById('firstInningsScorecardDataContainer');
        const closeFirstInningsModalBtn = document.getElementById('closeFirstInningsModalBtn');
        // Duplicates removed from here

        const closeSecondInnModalBtn = document.getElementById('closeSecondInningsModalBtn');
        const secondInnModal = document.getElementById('secondInningsScorecardModal');

        if (closeSecondInnModalBtn && secondInnModal) {
            closeSecondInnModalBtn.addEventListener('click', () => {
                secondInnModal.style.display = 'none';
            });
        }

        let innings1Log = fullMatchData.innings1_log || [];
        let innings2Log = fullMatchData.innings2_log || [];
        let ballEvents = [];
        let currentInningsNumber = 1;
        let currentBallOverallIndex = -1;
        let runningScoreInInnings = 0;
        let runningWicketsInInnings = 0;
        let runningLegalBallsInInnings = 0;
        let targetToChase = 0;
        let autoPlayInterval = null;

        function formatOver(legalBalls) {
            if (legalBalls === undefined || legalBalls === null || legalBalls < 0) return "0.0";
            const overs = Math.floor(legalBalls / 6);
            const ballsInOver = legalBalls % 6;
            return `${overs}.${ballsInOver}`;
        }

        function parseEventStringForLed(eventString) {
            let outcomeText = "---";
            let outcomeClass = "led-default"; // Default style
            const upperEvent = eventString.toUpperCase();

            // Extract the core part of the event before "SCORE:"
            const scoreIndex = upperEvent.indexOf(" SCORE:");
            if (scoreIndex === -1) return { outcomeText, outcomeClass }; // Should not happen with valid logs

            const coreEventPart = upperEvent.substring(0, scoreIndex).trim(); // e.g., "0.1 JADEJA TO PANT 1" or "0.2 JADEJA TO PANT W" or "0.4 JADEJA TO PANT WIDE"

            // Check for Wicket first
            // Wicket indicator can be " W " in the core part or descriptive text after score
            const wicketInCore = coreEventPart.includes(" W "); // e.g. "PLAYER W"
            const caughtBy = upperEvent.includes("CAUGHT BY");
            const bowled = upperEvent.includes("BOWLED");
            const runOut = upperEvent.includes("RUN OUT"); // Check this specifically
            const lbw = upperEvent.includes("LBW");
            const stumped = upperEvent.includes("STUMPED");
            const hitWicket = upperEvent.includes("HIT WICKET");

            if (wicketInCore || caughtBy || bowled || runOut || lbw || stumped || hitWicket) {
                outcomeText = "WICKET";
                outcomeClass = "led-wicket";
                if (runOut) outcomeText = "RUN OUT";
                else if (bowled) outcomeText = "BOWLED";
                else if (caughtBy) outcomeText = "CAUGHT";
                // Add other specific wicket types if needed for outcomeText
            } else if (coreEventPart.includes(" WIDE")) { // Check for WIDE
                outcomeText = "WIDE";
                outcomeClass = "led-extra";
            } else if (coreEventPart.includes(" NOBALL") || coreEventPart.includes(" NO BALL")) { // Check for NO BALL
                outcomeText = "NO BALL";
                outcomeClass = "led-extra";
            } else {
                // Extract runs: the last part of coreEventPart, assuming it's like "... PLAYER {RUNS}"
                const parts = coreEventPart.split(" ");
                const potentialRun = parts[parts.length - 1];

                if (potentialRun === "0" || coreEventPart.includes("NO RUN")) {
                    outcomeText = "0"; // Standardize to "0"
                    outcomeClass = "led-runs-0";
                } else if (potentialRun === "1") {
                    outcomeText = "1";
                    outcomeClass = "led-runs-123";
                } else if (potentialRun === "2") {
                    outcomeText = "2";
                    outcomeClass = "led-runs-123";
                } else if (potentialRun === "3") {
                    outcomeText = "3";
                    outcomeClass = "led-runs-123";
                } else if (potentialRun === "4" || coreEventPart.includes("FOUR")) {
                    outcomeText = "4";
                    outcomeClass = "led-runs-456";
                } else if (potentialRun === "5") { // 5 runs are rare but possible (overthrows)
                    outcomeText = "5";
                    outcomeClass = "led-runs-456";
                } else if (potentialRun === "6" || coreEventPart.includes("SIX")) {
                    outcomeText = "6";
                    outcomeClass = "led-runs-456";
                } else {
                    // If it's not a recognized number, keep default or try to show it
                    outcomeText = potentialRun; // Could be an issue if parsing fails
                    outcomeClass = "led-default";
                }
            }
            return { outcomeText, outcomeClass };
        }


        function updateUIDisplay(logEntry) {
            runningScoreInInnings = logEntry.runs; runningWicketsInInnings = logEntry.wickets;
            runningLegalBallsInInnings = logEntry.balls;
            currentScoreEl.textContent = runningScoreInInnings; currentWicketsEl.textContent = runningWicketsInInnings;
            const oversStr = formatOver(runningLegalBallsInInnings); currentOversEl.textContent = oversStr;
            ledScoreEl.textContent = `${runningScoreInInnings}/${runningWicketsInInnings}`;
            const parsedLed = parseEventStringForLed(logEntry.event);
            ledOutcomeEl.textContent = parsedLed.outcomeText;
            const classesToRemove = ['led-runs-0', 'led-runs-123', 'led-runs-456', 'led-wicket', 'led-extra', 'led-default'];
            classesToRemove.forEach(cls => ledOutcomeEl.classList.remove(cls));
            if (parsedLed.outcomeClass) { ledOutcomeEl.classList.add(parsedLed.outcomeClass); }
            else { ledOutcomeEl.classList.add('led-default'); }

            if (currentInningsNumber === 1) {
                if (runningLegalBallsInInnings > 0) {
                    const runRate = (runningScoreInInnings / (runningLegalBallsInInnings / 6)).toFixed(2);
                    if (currentRunRateValue) currentRunRateValue.textContent = runRate;
                    if (currentRunRateDisplay) currentRunRateDisplay.style.display = 'inline';
                } else {
                    if (currentRunRateValue) currentRunRateValue.textContent = "0.00";
                    if (currentRunRateDisplay) currentRunRateDisplay.style.display = 'inline';
                }
                // Ensure 2nd innings displays are hidden during 1st innings
                if (secondInningsRRDisplay) secondInningsRRDisplay.style.display = 'none';
                if (requiredRunRateDisplay) requiredRunRateDisplay.style.display = 'none';
            } else if (currentInningsNumber === 2) {
                // Hide 1st innings RR display
                if (currentRunRateDisplay) currentRunRateDisplay.style.display = 'none';

                // Calculate and show 2nd Innings Current RR
                if (runningLegalBallsInInnings > 0) {
                    const currentRR = (runningScoreInInnings / (runningLegalBallsInInnings / 6)).toFixed(2);
                    if (secondInningsRRValue) secondInningsRRValue.textContent = currentRR;
                } else {
                    if (secondInningsRRValue) secondInningsRRValue.textContent = "0.00";
                }
                if (secondInningsRRDisplay) secondInningsRRDisplay.style.display = 'inline';

                // Calculate and show Required RR
                if (targetToChase > 0) {
                    const runsNeededForRRR = Math.max(0, targetToChase - runningScoreInInnings);
                    const ballsRemainingForRRR = Math.max(0, 120 - runningLegalBallsInInnings);

                    if (ballsRemainingForRRR > 0) {
                        const rrr = ((runsNeededForRRR / ballsRemainingForRRR) * 6).toFixed(2);
                        if (requiredRunRateValue) requiredRunRateValue.textContent = rrr;
                    } else {
                        if (runsNeededForRRR > 0) {
                            if (requiredRunRateValue) requiredRunRateValue.textContent = "---";
                        } else {
                            if (requiredRunRateValue) requiredRunRateValue.textContent = "0.00";
                        }
                    }
                    if (requiredRunRateDisplay) requiredRunRateDisplay.style.display = 'inline';
                }
            } else { // Match ended or other state
                if (currentRunRateDisplay) currentRunRateDisplay.style.display = 'none';
                if (secondInningsRRDisplay) secondInningsRRDisplay.style.display = 'none';
                if (requiredRunRateDisplay) requiredRunRateDisplay.style.display = 'none';
            }

            const ballNumMatch = logEntry.event.match(/^(\d+\.\d+)/);
            ledBallNumEl.textContent = ballNumMatch ? ballNumMatch[1] : oversStr;
            onStrikeBatsmanEl.textContent = logEntry.batsman || logEntry.batter1 || 'N/A';
            if (logEntry.batter1 === (logEntry.batsman || logEntry.batter1) ) { nonStrikeBatsmanEl.textContent = logEntry.batter2 || 'N/A'; }
            else { nonStrikeBatsmanEl.textContent = logEntry.batter1 || 'N/A'; }
            currentBowlerEl.textContent = logEntry.bowler || 'N/A';
            lastBallCommentaryEl.textContent = logEntry.event;
            const logEntryDiv = document.createElement('div'); logEntryDiv.classList.add('log-entry');
            logEntryDiv.textContent = logEntry.event; fullInningsLogEl.appendChild(logEntryDiv);
            fullInningsLogEl.scrollTop = fullInningsLogEl.scrollHeight;
            if (currentInningsNumber === 2 && targetToChase > 0) {
                targetInfoEl.classList.remove('hidden');
                const needed = Math.max(0, targetToChase - runningScoreInInnings);
                const remainingBalls = Math.max(0, 120 - runningLegalBallsInInnings);
                runsNeededEl.textContent = needed; ballsRemainingEl.textContent = remainingBalls;
            }
        }

        function setupInningsUI(inningsNo) {
            const batTeamCode = inningsNo === 1 ? fullMatchData.innings1_bat_team : fullMatchData.innings2_bat_team;
            const bowlTeamCode = inningsNo === 1 ? fullMatchData.innings2_bat_team : fullMatchData.innings1_bat_team;
            let batTeamData = (batTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;
            let bowlTeamData = (bowlTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;
            battingTeamNameEl.textContent = batTeamData.fullName || batTeamCode;
            battingTeamLogoEl.src = batTeamData.logo || ''; battingTeamLogoEl.alt = (batTeamData.name || batTeamCode) + ' Logo';
            bowlingTeamNameEl.textContent = bowlTeamData.fullName || bowlTeamCode;
            bowlingTeamLogoEl.src = bowlTeamData.logo || ''; bowlingTeamLogoEl.alt = (bowlTeamData.name || bowlTeamCode) + ' Logo';
            fullInningsLogEl.innerHTML = `<h3 style="color:#f1c40f; text-align:center;">Innings ${inningsNo}</h3>`; // Updated log header
            lastBallCommentaryEl.textContent = `Start of Innings ${inningsNo}.`;
            currentScoreEl.textContent = "0"; currentWicketsEl.textContent = "0"; currentOversEl.textContent = "0.0";
            ledScoreEl.textContent = "0/0"; ledBallNumEl.textContent = "0.0";
            ledOutcomeEl.className = 'led-default'; ledOutcomeEl.textContent = "---";
            if (inningsNo === 2) {
                targetToChase = fullMatchData.innings1_runs + 1;
                targetScoreEl.textContent = targetToChase; runsNeededEl.textContent = targetToChase;
                ballsRemainingEl.textContent = 120; targetInfoEl.classList.remove('hidden');
                // displayFirstInningsScorecard(); // Call Removed
                 // Populate and show 1st Innings Summary line (this part remains, and button is added here)
                if (firstInningsSummaryDisplay && fullMatchData) {
                    const firstInnBatTeamCode = fullMatchData.innings1_bat_team;
                    const firstInnBatTeamData = (firstInnBatTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;

                    let summaryHTML = `
                        <img src="${firstInnBatTeamData.logo || ''}" alt="${(firstInnBatTeamData.name || firstInnBatTeamCode) + ' Logo'}" class="team-logo-pbs" id="firstInningsTeamLogo">
                        <div>
                            <span class="name" id="firstInningsTeamName">${firstInnBatTeamData.fullName || firstInnBatTeamCode}</span>
                            <span class="score-details">Score:
                                <span id="firstInningsTeamScore">${fullMatchData.innings1_runs}</span>/
                                <span id="firstInningsTeamWickets">${fullMatchData.innings1_wickets}</span>
                                (<span id="firstInningsTeamOvers">${formatOver(fullMatchData.innings1_balls)}</span> Overs)
                            </span>
                            <button class="view-scorecard-btn" id="viewFirstInningsScorecardBtn">View Scorecard</button>
                        </div>
                    `;
                    firstInningsSummaryDisplay.innerHTML = summaryHTML;
                    firstInningsSummaryDisplay.style.display = 'flex';

                    // Attach event listener to the newly created button
                    const viewFirstInnScorecardBtn = document.getElementById('viewFirstInningsScorecardBtn');
                    if (viewFirstInnScorecardBtn && firstInningsScorecardModal && firstInningsScorecardDataContainer) {
                        viewFirstInnScorecardBtn.addEventListener('click', () => {
                            if (!fullMatchData) return; // Safety check

                            const teamsDataForFunc = {
                                [fullMatchData.team1_code.toLowerCase()]: fullMatchData.team1_data,
                                [fullMatchData.team2_code.toLowerCase()]: fullMatchData.team2_data
                            };

                            let firstInningsHtmlContent = generateInningsHTML(
                                1, // Innings Number
                                fullMatchData.innings1_bat_team,
                                (fullMatchData.innings1_bat_team.toLowerCase() === fullMatchData.team1_code.toLowerCase() ? fullMatchData.team2_code : fullMatchData.team1_code), // Bowling team
                                fullMatchData.innings1_runs,
                                fullMatchData.innings1_wickets,
                                fullMatchData.innings1_balls,
                                fullMatchData.innings1_battracker,
                                fullMatchData.innings1_bowltracker,
                                teamsDataForFunc
                            );

                            // Updated HR tag to match generateInningsHTML
                            const hrTagToRemove = '<hr style="border:0; height: 1px; background: var(--scorecard-table-border, #4a6572); margin-top: 20px; margin-bottom: 10px;">';

                            if (firstInningsHtmlContent.endsWith(hrTagToRemove)) {
                                firstInningsHtmlContent = firstInningsHtmlContent.substring(0, firstInningsHtmlContent.length - hrTagToRemove.length);
                            }

                            firstInningsScorecardDataContainer.innerHTML = firstInningsHtmlContent;
                            firstInningsScorecardModal.style.display = 'flex';
                        });
                    }
                }

            } else { // Innings 1 or replay reset
                targetInfoEl.classList.add('hidden');
                // if (firstInningsScorecardDiv) firstInningsScorecardDiv.style.display = 'none'; // Old reference removed
                if (firstInningsSummaryDisplay) {
                    firstInningsSummaryDisplay.style.display = 'none';
                    firstInningsSummaryDisplay.innerHTML = '';
                }
            }
        }

        // Removed displayFirstInningsScorecard() function

        function generateInningsHTML(inningsNum, batTeamCode, bowlTeamCode, inningsRuns, inningsWickets, inningsBalls, battracker, bowltracker, teamsFullData) {
            let batTeamName = (teamsFullData[batTeamCode.toLowerCase()] ? teamsFullData[batTeamCode.toLowerCase()].fullName : batTeamCode.toUpperCase());
            let bowlTeamName = (teamsFullData[bowlTeamCode.toLowerCase()] ? teamsFullData[bowlTeamCode.toLowerCase()].fullName : bowlTeamCode.toUpperCase());

            let html = `<h4 style="color: var(--scorecard-table-text); margin-top: 20px;">Innings ${inningsNum}: ${batTeamName}</h4>`; // Use variable for h4 color
            html += '<table class="scorecard-table"><thead><tr><th>Player</th><th>How Out</th><th>Runs</th><th>Balls</th><th>SR</th></tr></thead><tbody>';

            if (battracker && typeof battracker === 'object') {
                for (const playerInitial in battracker) {
                    const stats = battracker[playerInitial];
                    const playerName = playerInitial; // Using initial as displayName might not be in tracker
                    const runs = stats.runs || 0;
                    const balls = stats.balls || 0;
                    const sr = balls > 0 ? ((runs / balls) * 100).toFixed(2) : "0.00";
                    const howOut = stats.how_out || ( (balls > 0 || runs > 0 || stats.order <= (runningWicketsInInnings+2) ) ? "Not out" : "DNB");
                    html += `<tr><td>${playerName}</td><td>${howOut}</td><td>${runs}</td><td>${balls}</td><td>${sr}</td></tr>`;
                }
            }
            html += '</tbody></table>';
            const oversStr = formatOver(inningsBalls);
            html += `<p style="color: var(--scorecard-table-text); font-weight: bold;">Total: ${inningsRuns}/${inningsWickets} (${oversStr} Overs)</p>`; // Use variable

            html += `<h5 style="color: var(--scorecard-table-text); margin-top:15px;">Bowling: ${bowlTeamName}</h5>`; // Use variable
            html += '<table class="scorecard-table"><thead><tr><th>Player</th><th>Overs</th><th>Runs</th><th>Wickets</th><th>Economy</th></tr></thead><tbody>';
            if (bowltracker && typeof bowltracker === 'object') {
                for (const playerInitial in bowltracker) {
                    const stats = bowltracker[playerInitial];
                    const playerName = playerInitial;
                    const ballsBowled = stats.balls_bowled || stats.balls || 0; // stats.balls might be from old format
                    const overs = formatOver(ballsBowled);
                    const runsConceded = stats.runs_conceded || stats.runs || 0;
                    const wicketsTaken = stats.wickets || 0;
                    const economy = ballsBowled > 0 ? ((runsConceded / (ballsBowled / 6))).toFixed(2) : "0.00";
                    html += `<tr><td>${playerName}</td><td>${overs}</td><td>${runsConceded}</td><td>${wicketsTaken}</td><td>${economy}</td></tr>`;
                }
            }
            html += '</tbody></table> <hr style="border:0; height: 1px; background: var(--scorecard-table-border, #4a6572); margin-top: 20px; margin-bottom: 10px;">'; // Use variable and ensure it's a simple line
            return html;
        }

        function generateFullScorecardHTML(matchData) {
            let html = `<div style="padding:10px;">`;
            // The main H2 "Full Match Scorecard" is static in the modal. This H3 is for the toss message.
            html += `<h3 style="color: var(--subheading-color); text-align:center; margin-bottom:15px;">${matchData.toss_msg}</h3> <hr style="border-color: var(--log-entry-border); margin-bottom:20px;">`; // Use variables

            const teamsDataForFunc = { // Create a map for easy lookup by code
                [matchData.team1_code.toLowerCase()]: matchData.team1_data,
                [matchData.team2_code.toLowerCase()]: matchData.team2_data
            };

            html += generateInningsHTML(1, matchData.innings1_bat_team, (matchData.innings1_bat_team === matchData.team1_code ? matchData.team2_code : matchData.team1_code),
                                       matchData.innings1_runs, matchData.innings1_wickets, matchData.innings1_balls,
                                       matchData.innings1_battracker, matchData.innings1_bowltracker, teamsDataForFunc);

            if (matchData.innings2_runs !== undefined) { // Check if second innings data exists
                 html += generateInningsHTML(2, matchData.innings2_bat_team, (matchData.innings2_bat_team === matchData.team1_code ? matchData.team2_code : matchData.team1_code),
                                       matchData.innings2_runs, matchData.innings2_wickets, matchData.innings2_balls,
                                       matchData.innings2_battracker, matchData.innings2_bowltracker, teamsDataForFunc);
            }

            html += `<div class="result-highlight-replay"><h4>Result</h4><p style="font-size:1.1em; font-weight:bold;">${matchData.win_msg}</p></div>`;
            html += `<button id="newCloseScorecardBtn" class="new-scorecard-close-button">Close Scorecard</button>`;
            html += `</div>`; // This is the closing div for the 'padding:10px' div
            return html;
        }


        function initializeReplay() {
            ballEvents = innings1Log.concat(innings2Log);
            if (ballEvents.length === 0 && (!innings1Log || innings1Log.length === 0)) {
                lastBallCommentaryEl.textContent = "No ball-by-ball data available for this match.";
                disableControls();
                winMessageContainerEl.textContent = fullMatchData.win_msg || "Match data incomplete.";
                winMessageContainerEl.classList.remove('hidden');
                if(fullMatchData.innings1_runs !== undefined) { // If there's at least innings 1 summary, show scorecard
                    const scorecardHTML = generateFullScorecardHTML(fullMatchData);
                    finalScorecardDiv.innerHTML = scorecardHTML;
                    finalScorecardDiv.style.display = 'block';
                }
                return;
            }
            tossDisplayEl.textContent = fullMatchData.toss_msg;
            currentInningsNumber = 1;
            currentBallOverallIndex = -1;
            runningScoreInInnings = 0; runningWicketsInInnings = 0; runningLegalBallsInInnings = 0;
            setupInningsUI(1);
            winMessageContainerEl.classList.add('hidden');
            nextBallBtn.disabled = false;
            startAutoPlayBtn.disabled = false;
            pauseAutoPlayBtn.classList.add('hidden');
            simSpeedSelect.disabled = false; // Keep this, it's not a display style
            // finalScorecardDiv.style.display = 'none'; // Content area, not modal itself
            if (finalScorecardModal) finalScorecardModal.style.display = 'none'; // Hide modal at start
            // if (firstInningsScorecardDiv) firstInningsScorecardDiv.style.display = 'none'; // This line is removed as variable is removed
            if (firstInningsSummaryDisplay) { // Hide and clear summary line
                firstInningsSummaryDisplay.style.display = 'none';
                firstInningsSummaryDisplay.innerHTML = '';
            }

            // Hide 2nd Innings Summary and clear its content
            const secondInnSummary = document.getElementById('secondInningsSummaryDisplay');
            if (secondInnSummary) {
                secondInnSummary.style.display = 'none';
                secondInnSummary.innerHTML = ''; // Clear any previous content
            }

            // Hide 2nd Innings Scorecard Modal
            const secondInnModal = document.getElementById('secondInningsScorecardModal');
            if (secondInnModal) {
                secondInnModal.style.display = 'none';
            }

            if (currentRunRateDisplay) currentRunRateDisplay.style.display = 'none';
            if (secondInningsRRDisplay) secondInningsRRDisplay.style.display = 'none';
            if (requiredRunRateDisplay) requiredRunRateDisplay.style.display = 'none';

            // Explicitly set display styles and states for control bar elements
            const nextBallButton = document.getElementById('nextBallBtn');
            if (nextBallButton) {
                nextBallButton.style.display = 'inline-block';
                nextBallButton.disabled = false;
            }

            const speedControl = document.querySelector('.speed-control-container');
            if (speedControl) speedControl.style.display = 'flex';
            // simSpeedSelect.disabled = false; // Already handled above and at end of pause listener

            const startAutoPlayButton = document.getElementById('startAutoPlayBtn');
            if (startAutoPlayButton) {
                startAutoPlayButton.style.display = 'inline-block';
                startAutoPlayButton.classList.remove('hidden');
                startAutoPlayButton.disabled = false;
            }

            const pauseAutoPlayButton = document.getElementById('pauseAutoPlayBtn');
            if (pauseAutoPlayButton) {
                pauseAutoPlayButton.style.display = 'none';
                pauseAutoPlayButton.classList.add('hidden');
                pauseAutoPlayButton.disabled = true;
            }

            const viewScorecardButton = document.getElementById('viewScorecardBtn');
            if (viewScorecardButton) {
                viewScorecardButton.style.display = 'none';
                // Event listener for View Scorecard button (setup once)
                if (!viewScorecardButton.hasAttribute('data-listener-attached')) {
                    viewScorecardButton.addEventListener('click', () => {
                        if (finalScorecardModal) finalScorecardModal.style.display = 'flex';
                        if (bottomControlBar) bottomControlBar.style.display = 'none'; // Hide control bar when modal is shown
                    });
                    viewScorecardButton.setAttribute('data-listener-attached', 'true');
                }
            }

            if (bottomControlBar) bottomControlBar.style.display = 'flex'; // Ensure control bar itself is visible

            // console.log statements for startAutoPlayBtn and pauseAutoPlayBtn can be removed if states are clear from above
            console.log('[DEBUG] initializeReplay called.');

            if (firstInningsScorecardModal) { // Hide new modal
                firstInningsScorecardModal.style.display = 'none';
            }
            // nextBallBtn.disabled = false; // Handled above
            // simSpeedSelect.disabled = false; // Handled above
            // Redundant bottomControlBar.style.display = 'flex'; removed
            // Redundant startAutoPlayBtn settings removed
            // Redundant pauseAutoPlayBtn settings removed
        }


        // Event listener for closing the First Innings Scorecard Modal (should be in initialize or global)
        if (closeFirstInningsModalBtn && firstInningsScorecardModal) {
            closeFirstInningsModalBtn.addEventListener('click', () => {
                firstInningsScorecardModal.style.display = 'none';
            });
        }

        function handleEndOfMatch() {
            winMessageContainerEl.textContent = fullMatchData.win_msg || "Match Concluded.";
            winMessageContainerEl.classList.remove('hidden'); // Show text message on main page
            disableControls();

            // Ensure First Innings Summary is visible (it's usually populated in setupInningsUI(2))
            const firstInnSummary = document.getElementById('firstInningsSummaryDisplay');
            if (firstInnSummary && firstInnSummary.innerHTML.trim() !== '') { // Check if populated
                firstInnSummary.style.display = 'flex';
            } else if (firstInnSummary && fullMatchData.innings1_bat_team && fullMatchData.innings1_runs !== undefined) {
                // If innings 2 never started, setupInningsUI(2) was never called. Populate 1st innings summary here.
                const firstInnBatTeamCode = fullMatchData.innings1_bat_team;
                const firstInnBatTeamData = (firstInnBatTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;
                let firstSummaryHTML = `
                    <img src="${firstInnBatTeamData.logo || ''}" alt="${(firstInnBatTeamData.fullName || firstInnBatTeamCode) + ' Logo'}" class="team-logo-pbs">
                    <div>
                        <span class="name">${firstInnBatTeamData.fullName || firstInnBatTeamCode}</span>
                        <span class="score-details">Score:
                            <span>${fullMatchData.innings1_runs}</span>/<span>${fullMatchData.innings1_wickets}</span>
                            (${formatOver(fullMatchData.innings1_balls)} Overs)
                        </span>
                        <button class="view-scorecard-btn" id="viewFirstInningsScorecardBtn">View Scorecard</button>
                    </div>
                `;
                firstInnSummary.innerHTML = firstSummaryHTML;
                firstInnSummary.style.display = 'flex';
                // Note: Event listener for this dynamically added viewFirstInningsScorecardBtn will be handled in the next subtask.
            }

            const secondInnSummary = document.getElementById('secondInningsSummaryDisplay');
            if (secondInnSummary && fullMatchData.innings2_bat_team && fullMatchData.innings2_runs !== undefined) {
                const secondInnBatTeamCode = fullMatchData.innings2_bat_team;
                const secondInnBatTeamData = (secondInnBatTeamCode.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team1_data : fullMatchData.team2_data;

                const teamLogo = secondInnBatTeamData.logo || '';
                const teamFullName = secondInnBatTeamData.fullName || secondInnBatTeamCode;
                const runs = fullMatchData.innings2_runs;
                const wickets = fullMatchData.innings2_wickets;
                const balls = fullMatchData.innings2_balls;
                const oversFormatted = formatOver(balls);

                let summaryHTML = `
                    <img src="${teamLogo}" alt="${teamFullName} Logo" class="team-logo-pbs">
                    <div>
                        <span class="name">${teamFullName}</span>
                        <span class="score-details">Score:
                            <span>${runs}</span>/<span>${wickets}</span>
                            (${oversFormatted} Overs)
                        </span>
                        <button class="view-scorecard-btn" id="viewSecondInningsScorecardBtn">View Scorecard</button>
                    </div>
                `;
                secondInnSummary.innerHTML = summaryHTML;
                secondInnSummary.style.display = 'flex';

                const viewSecondInnScorecardBtn = document.getElementById('viewSecondInningsScorecardBtn');
                if (viewSecondInnScorecardBtn) {
                    viewSecondInnScorecardBtn.addEventListener('click', () => {
                        if (!fullMatchData || !fullMatchData.innings2_bat_team) return; // Safety check

                        const teamsDataForFunc = { // Create a map for easy lookup by code
                            [fullMatchData.team1_code.toLowerCase()]: fullMatchData.team1_data,
                            [fullMatchData.team2_code.toLowerCase()]: fullMatchData.team2_data
                        };

                        // Determine bowling team for 2nd innings
                        const secondInningsBatTeam = fullMatchData.innings2_bat_team;
                        const secondInningsBowlTeam = (secondInningsBatTeam.toLowerCase() === fullMatchData.team1_code.toLowerCase()) ? fullMatchData.team2_code : fullMatchData.team1_code;

                        let secondInningsHtmlContent = generateInningsHTML(
                            2, // Innings Number
                            secondInningsBatTeam,
                            secondInningsBowlTeam,
                            fullMatchData.innings2_runs,
                            fullMatchData.innings2_wickets,
                            fullMatchData.innings2_balls,
                            fullMatchData.innings2_battracker,
                            fullMatchData.innings2_bowltracker,
                            teamsDataForFunc
                        );

                        const hrTagToRemove = '<hr style="border:0; height: 1px; background: var(--scorecard-table-border, #4a6572); margin-top: 20px; margin-bottom: 10px;">';
                        if (secondInningsHtmlContent.endsWith(hrTagToRemove)) {
                            secondInningsHtmlContent = secondInningsHtmlContent.substring(0, secondInningsHtmlContent.length - hrTagToRemove.length);
                        }

                        const dataContainer = document.getElementById('secondInningsScorecardDataContainer');
                        const modal = document.getElementById('secondInningsScorecardModal');

                        if (dataContainer && modal) {
                            dataContainer.innerHTML = secondInningsHtmlContent;
                            modal.style.display = 'flex';
                        }
                    });
                }

            } else if (secondInnSummary) {
                secondInnSummary.style.display = 'none'; // Ensure it's hidden if no 2nd innings data
            }

            // Event listener for the dynamically added viewFirstInningsScorecardBtn (if match ended in 1st innings)
            const dynamicViewFirstInnBtn = document.getElementById('viewFirstInningsScorecardBtn');
            // Check if it's the one inside firstInnSummary (not the one from setupInningsUI(2))
            // This check can be tricky. A more robust way would be to ensure the button from setupInningsUI(2)
            // is the only one, or ensure this listener is only added if setupInningsUI(2) wasn't called.
            // For now, we rely on the population logic: if firstInnSummary was populated HERE, its button needs a listener.
            if (dynamicViewFirstInnBtn && firstInnSummary && firstInnSummary.contains(dynamicViewFirstInnBtn) && !dynamicViewFirstInnBtn.hasAttribute('data-listener-attached-dynamic')) {
                 dynamicViewFirstInnBtn.addEventListener('click', () => {
                    // This logic is similar to the one in setupInningsUI(2) for the first innings button
                    if (!fullMatchData) return;
                    const teamsDataForFunc = {
                        [fullMatchData.team1_code.toLowerCase()]: fullMatchData.team1_data,
                        [fullMatchData.team2_code.toLowerCase()]: fullMatchData.team2_data
                    };
                    let firstInningsHtmlContent = generateInningsHTML(
                        1, fullMatchData.innings1_bat_team,
                        (fullMatchData.innings1_bat_team.toLowerCase() === fullMatchData.team1_code.toLowerCase() ? fullMatchData.team2_code : fullMatchData.team1_code),
                        fullMatchData.innings1_runs, fullMatchData.innings1_wickets, fullMatchData.innings1_balls,
                        fullMatchData.innings1_battracker, fullMatchData.innings1_bowltracker, teamsDataForFunc
                    );
                    const hrTagToRemove = '<hr style="border:0; height: 1px; background: var(--scorecard-table-border, #4a6572); margin-top: 20px; margin-bottom: 10px;">';
                    if (firstInningsHtmlContent.endsWith(hrTagToRemove)) {
                        firstInningsHtmlContent = firstInningsHtmlContent.substring(0, firstInningsHtmlContent.length - hrTagToRemove.length);
                    }
                    const dataContainer = document.getElementById('firstInningsScorecardDataContainer'); // Ensure this ID is correct for the 1st innings modal
                    const modal = document.getElementById('firstInningsScorecardModal');
                    if (dataContainer && modal) {
                        dataContainer.innerHTML = firstInningsHtmlContent;
                        modal.style.display = 'flex';
                    }
                });
                dynamicViewFirstInnBtn.setAttribute('data-listener-attached-dynamic', 'true');
            }


            const scorecardHTML = generateFullScorecardHTML(fullMatchData);
            // The h2 title "Full Match Scorecard" is now static in the modal HTML.
            // So, generateFullScorecardHTML should ideally not add it again.
            // For now, we assume generateFullScorecardHTML populates the content *within* finalScorecardDisplay.
            // If generateFullScorecardHTML includes its own h2, it might look duplicated.
            // Let's adjust generateFullScorecardHTML to not add the main H2 title if it's static in modal.
            // For this step, we'll populate the div and show modal.
            finalScorecardDiv.innerHTML = scorecardHTML; // Populate the content area

            // Add event listener for the new close button
            const newCloseBtn = document.getElementById('newCloseScorecardBtn');
            if (newCloseBtn) {
                newCloseBtn.addEventListener('click', () => {
                    if (finalScorecardModal) finalScorecardModal.style.display = 'none';

                    // Hide gameplay controls
                    const nextBallButton = document.getElementById('nextBallBtn');
                    const speedControl = document.querySelector('.speed-control-container');
                    const startAutoPlayButton = document.getElementById('startAutoPlayBtn');
                    const pauseAutoPlayButton = document.getElementById('pauseAutoPlayBtn');

                    if (nextBallButton) nextBallButton.style.display = 'none';
                    if (speedControl) speedControl.style.display = 'none';
                    if (startAutoPlayButton) startAutoPlayButton.style.display = 'none';
                    if (pauseAutoPlayButton) pauseAutoPlayButton.style.display = 'none';

                    // Show View Scorecard button
                    const viewScorecardButton = document.getElementById('viewScorecardBtn');
                    if (viewScorecardButton) viewScorecardButton.style.display = 'inline-block';

                    if (bottomControlBar) bottomControlBar.style.display = 'flex';
                });
            }

            if (finalScorecardModal) finalScorecardModal.style.display = 'flex'; // Show modal
            // When match ends, initially hide all controls in bottom bar except viewScorecardBtn
            // This logic will be handled by the newCloseScorecardBtn click,
            // and also needs to be applied if the user closes the modal via the 'X' button.
            // For now, the default behavior of hiding the entire bar is kept,
            // but the new button's click will override it.
            // A more comprehensive solution would involve a function to set this state.
            if (bottomControlBar) bottomControlBar.style.display = 'none'; // Hide the control bar

            // Hide first innings scorecard if it's still visible
            // if (firstInningsScorecardDiv) { // This line is removed as variable is removed
            //     firstInningsScorecardDiv.style.display = 'none';
            // }
        }

        function disableControls() {
            nextBallBtn.disabled = true;
            simSpeedSelect.disabled = true;
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
            }
            // Explicitly set final state for both buttons
            console.log('[DEBUG] disableControls called.');
            startAutoPlayBtn.classList.add('hidden');
            startAutoPlayBtn.style.display = 'none';
            startAutoPlayBtn.disabled = true;
            console.log('[DEBUG] startAutoPlayBtn hidden, display none, disabled.');

            pauseAutoPlayBtn.classList.add('hidden');
            pauseAutoPlayBtn.style.display = 'none';
            pauseAutoPlayBtn.disabled = true;
            console.log('[DEBUG] pauseAutoPlayBtn hidden, display none, disabled.');
        }

        function handleNextBall() {
            // ... (rest of handleNextBall, setupInningsUI, updateUIDisplay, parseEventStringForLed, formatOver as before) ...
            // Ensure this doesn't get re-enabled if modal is open.
            // The winMessageContainerEl check should handle this for nextBallBtn clicks.
            if (winMessageContainerEl.classList.contains('hidden') === false && finalScorecardModal.style.display === 'none') return; // Allow next ball if modal not shown
            currentBallOverallIndex++;
            if (currentBallOverallIndex >= ballEvents.length) { handleEndOfMatch(); return; }
            let currentBallEventData = ballEvents[currentBallOverallIndex];
            let previousInningsNumber = currentInningsNumber;
            if (currentInningsNumber === 1 && currentBallOverallIndex >= innings1Log.length) {
                if (innings2Log.length > 0) { currentInningsNumber = 2; }
                else { handleEndOfMatch(); return; }
            }
            if (currentInningsNumber !== previousInningsNumber) { setupInningsUI(2); }
            updateUIDisplay(currentBallEventData);
            if (currentInningsNumber === 2 && targetToChase > 0 && runningScoreInInnings >= targetToChase) { handleEndOfMatch(); }
            else if (currentBallOverallIndex === ballEvents.length - 1) { handleEndOfMatch(); }
        }

        nextBallBtn.addEventListener('click', handleNextBall);
        startAutoPlayBtn.addEventListener('click', () => {
            if (winMessageContainerEl.classList.contains('hidden')) { // If game not over
                console.log('[DEBUG] startAutoPlayBtn clicked. Current state: start visible, pause hidden.');

                startAutoPlayBtn.classList.add('hidden');
                startAutoPlayBtn.style.display = 'none'; // Direct style manipulation
                console.log('[DEBUG] startAutoPlayBtn hidden and display set to none.');

                pauseAutoPlayBtn.classList.remove('hidden');
                pauseAutoPlayBtn.style.display = 'inline-block'; // Or 'block', depending on original display type
                pauseAutoPlayBtn.disabled = false; // Ensure it's enabled
                console.log('[DEBUG] pauseAutoPlayBtn shown, display set to inline-block, and enabled.');

                nextBallBtn.disabled = true; simSpeedSelect.disabled = true;
                const speed = parseInt(simSpeedSelect.value, 10);
                function autoPlay() {
                    if (!winMessageContainerEl.classList.contains('hidden')) {
                        clearInterval(autoPlayInterval); autoPlayInterval = null;
                        // No need to toggle buttons here, disableControls will handle it
                        disableControls(); return;
                    }
                    handleNextBall();
                }
                autoPlay(); // Call once immediately
                if (!winMessageContainerEl.classList.contains('hidden')) return; // Don't start interval if game ended on first sync call
                autoPlayInterval = setInterval(autoPlay, speed);
            }
        });
        pauseAutoPlayBtn.addEventListener('click', () => {
            console.log('[DEBUG] pauseAutoPlayBtn clicked. Current state: pause visible, start hidden.');
            clearInterval(autoPlayInterval); autoPlayInterval = null;

            pauseAutoPlayBtn.classList.add('hidden');
            pauseAutoPlayBtn.style.display = 'none'; // Direct style manipulation
            pauseAutoPlayBtn.disabled = true; // Disable it when hidden
            console.log('[DEBUG] pauseAutoPlayBtn hidden, display set to none, and disabled.');

            if (!winMessageContainerEl.classList.contains('hidden')) { // Game is over
                // disableControls() would have been called, but to be safe:
                startAutoPlayBtn.classList.add('hidden');
                startAutoPlayBtn.style.display = 'none';
                startAutoPlayBtn.disabled = true;
                console.log('[DEBUG] Game is over, startAutoPlayBtn remains hidden and disabled.');
                nextBallBtn.disabled = true; // Ensure this is also disabled
            } else { // Game not over
                startAutoPlayBtn.classList.remove('hidden');
                startAutoPlayBtn.style.display = 'inline-block';
                startAutoPlayBtn.disabled = false;
                console.log('[DEBUG] startAutoPlayBtn shown, display set to inline-block, and enabled.');
                nextBallBtn.disabled = false;
            }
            simSpeedSelect.disabled = false; // Always re-enable speed select when pausing
        });

        if (closeScorecardModalBtn && finalScorecardModal) {
            closeScorecardModalBtn.addEventListener('click', () => {
                finalScorecardModal.style.display = 'none';
                if (bottomControlBar) bottomControlBar.style.display = 'flex'; // Show the control bar again
            });
        }

        // Theme Toggle Logic for replay_ball_by_ball.html
        const themeToggleBtnReplay = document.getElementById('themeToggleBtnBallByBall');
        const currentThemeReplay = localStorage.getItem('theme'); // Use the same localStorage key 'theme'

        function applyThemeReplay(theme) {
            if (theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                if (themeToggleBtnReplay) themeToggleBtnReplay.textContent = 'Light Mode';
            } else {
                document.body.setAttribute('data-theme', 'light');
                if (themeToggleBtnReplay) themeToggleBtnReplay.textContent = 'Dark Mode';
            }
        }

        if (currentThemeReplay) {
            applyThemeReplay(currentThemeReplay);
        } else {
            applyThemeReplay('light'); // Default to light theme
        }

        if (themeToggleBtnReplay) {
            themeToggleBtnReplay.addEventListener('click', () => {
                let newTheme = 'light';
                if (document.body.getAttribute('data-theme') === 'light') {
                    newTheme = 'dark';
                }
                applyThemeReplay(newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }
        // End of Theme Toggle Logic

        initializeReplay();
    </script>
</body>
</html>
